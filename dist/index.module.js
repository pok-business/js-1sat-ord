import{Script as t,Transaction as r,TxIn as e,P2PKHAddress as n,TxOut as o,SigHash as i}from"bsv-wasm";import{Buffer as s}from"buffer";import a from"fs";import u from"path";import c from"os";import{Sigma as g}from"sigma-protocol";function _(t,r){(null==r||r>t.length)&&(r=t.length);for(var e=0,n=new Array(r);e<r;e++)n[e]=t[e];return n}function l(t,r){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(e)return(e=e.call(t)).next.bind(e);if(Array.isArray(t)||(e=function(t,r){if(t){if("string"==typeof t)return _(t,r);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?_(t,r):void 0}}(t))||r&&t&&"number"==typeof t.length){e&&(t=e);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}const d=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/gm;function v(t){console.log(`[dotenv@16.0.3][DEBUG] ${t}`)}const f={config:function(t){let r=u.resolve(process.cwd(),".env"),e="utf8";const n=Boolean(t&&t.debug),o=Boolean(t&&t.override);var i;t&&(null!=t.path&&(r="~"===(i=t.path)[0]?u.join(c.homedir(),i.slice(1)):i),null!=t.encoding&&(e=t.encoding));try{const t=f.parse(a.readFileSync(r,{encoding:e}));return Object.keys(t).forEach(function(r){Object.prototype.hasOwnProperty.call(process.env,r)?(!0===o&&(process.env[r]=t[r]),n&&v(!0===o?`"${r}" is already defined in \`process.env\` and WAS overwritten`:`"${r}" is already defined in \`process.env\` and was NOT overwritten`)):process.env[r]=t[r]}),{parsed:t}}catch(t){return n&&v(`Failed to load ${r} ${t.message}`),{error:t}}},parse:function(t){const r={};let e,n=t.toString();for(n=n.replace(/\r\n?/gm,"\n");null!=(e=d.exec(n));){const t=e[1];let n=e[2]||"";n=n.trim();const o=n[0];n=n.replace(/^(['"`])([\s\S]*)\1$/gm,"$2"),'"'===o&&(n=n.replace(/\\n/g,"\n"),n=n.replace(/\\r/g,"\r")),r[t]=n}return r}};var p=f.config,m=f.parse,h=f;h.config=p,h.parse=m;var y=function(t){for(var r=[],e=0,n=t.length;e<n;e++){var o=Number(t.charCodeAt(e)).toString(16);r.push(o)}return r.join("")};p();var w=function(r,e,n,o){var i="";if(void 0!==e&&void 0!==n){var a=y("ord"),u=s.from(e,"base64").toString("hex");i="OP_0 OP_IF "+a+" OP_1 "+y(n)+" OP_0 "+u+" OP_ENDIF"}var c=r.get_locking_script().to_asm_string()+(i?" "+i:"");if(o&&null!=o&&o.app&&null!=o&&o.type){c=c+" OP_RETURN "+y("1PuQa7K62MiKCtssSLKy1kh56WWU7MtUR5")+" "+y("SET");for(var g=0,_=Object.entries(o);g<_.length;g++){var l=_[g],d=l[0],v=l[1];"cmd"!==d&&(c=c+" "+y(d)+" "+y(v))}}return t.from_asm_string(c)},I=function(i,a,u,c){try{var g=new r(1,0),_=new e(s.from(i.txid,"hex"),i.vout,t.from_asm_string(i.script));g.add_input(_);var l=w(n.from_string(a),null==u?void 0:u.dataB64,null==u?void 0:u.contentType,c),d=new o(BigInt(1),l);return g.add_output(d),Promise.resolve(g)}catch(t){return Promise.reject(t)}},x=function(t){var r=t.fundingTx,e=t.utxos,i=t.destinationAddress,s=t.changeAddress,a=t.satPerByteFee,u=t.inscription,c=t.additionalPayments,_=void 0===c?[]:c,d=t.metadata,v=t.signer;try{var f=r,p=w(n.from_string(i),u.dataB64,u.contentType,d),m=new o(BigInt(1),p);f.add_output(m);for(var h,y=l(_);!(h=y()).done;){var I=h.value,x=new o(I.amount,n.from_string(I.to).get_locking_script());f.add_output(x)}for(var B,k=0n,b=f.get_noutputs(),P=l(Array(b).keys());!(B=P()).done;){var O;k+=(null==(O=f.get_output(B.value))?void 0:O.get_satoshis())||0n}var A=n.from_string(s).get_locking_script(),T=Math.ceil(a*(f.get_size()+S)),j=BigInt(e.reduce(function(t,r){return t+r.satoshis},0))-k-BigInt(T);if(j<0)throw new Error("Inadequate satoshis for fee");if(j>0){var $=new o(BigInt(j),A);f.add_output($)}var E=null==v?void 0:v.idKey,F=new g(f).sign(E);return Promise.resolve(F.signedTx)}catch(t){return Promise.reject(t)}},B=function(a,u,c,_,d,v,f,p,m,h){void 0===v&&(v=[]);try{var y,I=function(r){if(!m&&y&&f){var e=x.sign(f,i.ALL|i.FORKID,0,t.from_asm_string(a.script),BigInt(a.satoshis));y.set_unlocking_script(t.from_asm_string(e.to_hex()+" "+f.to_public_key().to_hex())),x.set_input(0,y)}return x},x=m||new r(1,0);m||(y=new e(s.from(a.txid,"hex"),a.vout,t.from_asm_string("")),x.add_input(y));var B=w(n.from_string(u),d.dataB64,d.contentType,p),k=new o(BigInt(1),B);x.add_output(k);for(var b,O=l(v);!(b=O()).done;){var A=b.value,T=new o(A.amount,n.from_string(A.to).get_locking_script());x.add_output(T)}for(var j,$=0n,E=x.get_noutputs(),F=l(Array(E).keys());!(j=F()).done;){var K;$+=(null==(K=x.get_output(j.value))?void 0:K.get_satoshis())||0n}var M=n.from_string(c).get_locking_script(),R=Math.ceil(_*(x.get_size()+S+(m?0:P))),U=BigInt(a.satoshis)-$-BigInt(R);if(U<0)throw new Error("Inadequate satoshis for fee");if(U>0){var N=new o(BigInt(U),M);x.add_output(N)}var z=null==h?void 0:h.idKey,C=null==h?void 0:h.keyHost,D=function(){if(!z)return function(){if(C){var t=null==h?void 0:h.authToken,r=new g(x);return function(e,n){try{var o=Promise.resolve(r.remoteSign(C,t)).then(function(t){x=t.signedTx})}catch(t){return n(t)}return o&&o.then?o.then(void 0,n):o}(0,function(t){throw console.log(t),new Error("Remote signing to "+C+" failed")})}}();var t=new g(x).sign(z);x=t.signedTx}();return Promise.resolve(D&&D.then?D.then(I):I())}catch(t){return Promise.reject(t)}},k=function(a,u,c,g,_,d,v,f,p,m){void 0===m&&(m=[]);try{var h=new r(1,0),y=new e(s.from(u.txid,"hex"),u.vout,t.from_asm_string(""));h.add_input(y);var I,x=new e(s.from(a.txid,"hex"),a.vout,t.from_asm_string(""));h.add_input(x);var B=n.from_string(v);I=null!=f&&f.dataB64&&null!=f&&f.contentType?w(B,f.dataB64,f.contentType,p):B.get_locking_script();var k=new o(BigInt(1),I);h.add_output(k);for(var b,O=l(m);!(b=O()).done;){var A=b.value,T=new o(A.amount,n.from_string(A.to).get_locking_script());h.add_output(T)}for(var j,$=0n,E=h.get_noutputs(),F=l(Array(E).keys());!(j=F()).done;){var K;$+=(null==(K=h.get_output(j.value))?void 0:K.get_satoshis())||0n}var M=n.from_string(g).get_locking_script(),R=Math.ceil(_*(h.get_size()+S+2*P)),U=BigInt(a.satoshis)-$-BigInt(R),N=new o(U,M);h.add_output(N);var z=h.sign(d,i.InputOutput,0,t.from_asm_string(u.script),BigInt(u.satoshis));y.set_unlocking_script(t.from_asm_string(z.to_hex()+" "+d.to_public_key().to_hex())),h.set_input(0,y);var C=h.sign(c,i.InputOutput,1,t.from_asm_string(a.script),BigInt(a.satoshis));return x.set_unlocking_script(t.from_asm_string(C.to_hex()+" "+c.to_public_key().to_hex())),h.set_input(1,x),Promise.resolve(h)}catch(t){return Promise.reject(t)}},b=function(n,a,u,c){try{for(var g,_=new r(1,0),d=0,v=l(n||[]);!(g=v()).done;)d+=g.value.satoshis;var f=d-c;console.log({feeSats:c,satsIn:d,satsOut:f}),_.add_output(new o(BigInt(f),u.get_locking_script()));for(var p,m=0,h=l(n||[]);!(p=h()).done;){var y=p.value;console.log({u:y});var w=new e(s.from(y.txid,"hex"),y.vout,t.from_asm_string(""));console.log({inx:w}),w.set_satoshis(BigInt(y.satoshis)),_.add_input(w);var I=_.sign(a,i.InputOutputs,m,t.from_asm_string(y.script),BigInt(y.satoshis));w.set_unlocking_script(t.from_asm_string(I.to_hex()+" "+a.to_public_key().to_hex())),_.set_input(m,w),m++}return Promise.resolve(_)}catch(t){return Promise.reject(t)}},P=107,O=148,S=34;export{O as P2PKH_FULL_INPUT_SIZE,P as P2PKH_INPUT_SCRIPT_SIZE,S as P2PKH_OUTPUT_SIZE,w as buildInscription,I as buildReinscriptionTemplate,B as createOrdinal,x as createOrdinalFromFundingTx,k as sendOrdinal,b as sendUtxos};
//# sourceMappingURL=index.module.js.map
